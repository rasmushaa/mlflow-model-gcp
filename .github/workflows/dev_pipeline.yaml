# =============================================================================
# Development Training Pipeline - Feature & Model Branches
# =============================================================================
#
# PURPOSE:
# Allows rapid iteration and testing of ML training pipeline on development
# branches before merging to production.
#
# TRIGGER:
# Runs on pushes to feature/* and model/* branches
#
# LOGIC FLOW:
# 1. Run unit tests to validate code quality
# 2. Build Docker image for the current branch
# 3. Deploy to Cloud Run Job with branch-specific configuration
# 4. Execute training job with branch-specific MLflow experiment
#
# NAMING CONVENTION:
# - Image: banking-pipeline-dev:latest (shared for all dev branches)
# - Experiment: Banking-{branch-name}
# - Model: BankingModel-{branch-name}
#
# META:
# Build Docker image with embedded git commit SHA for traceability.
# The GIT_SHA build arg ensures the exact code version is baked into the image,
# allowing us to trace back which commit produced a particular model or result.
# Create environment variables file for Cloud Run Job.
# Git-related variables (GIT_COMMIT_USERNAME, GIT_COMMIT_AUTHOR_NAME, GIT_COMMIT_BRANCH)
# are passed to the training script and logged as MLflow metadata/tags.
# This enables tracking which developer, branch, and commit produced each model.
# =============================================================================

name: Development Training Pipeline

on:
  push:
    branches:
      - 'feature/*'
      - 'model/*'

jobs:
  training_pipeline_dev:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write' # This is crucial for Workload Identity Federation

    steps:
    - name: Init Environment Variables
      run: |
        # Use branch name for experiment and model naming
        BRANCH_NAME="${{ github.ref_name }}"
        # Sanitize branch name for use in resource names (replace / with -)
        SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')

        echo "IMAGE_URI=${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/banking-pipeline-dev:latest" >> $GITHUB_ENV
        echo "MLFLOW_EXPERIMENT_NAME=Banking-${SANITIZED_BRANCH}" >> $GITHUB_ENV
        echo "MLFLOW_MODEL_NAME=BankingModel-${SANITIZED_BRANCH}" >> $GITHUB_ENV
        echo "GIT_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_USERNAME=${{ github.actor }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_AUTHOR_NAME=${{ github.event.head_commit.author.name }}" >> $GITHUB_ENV

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id : ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL }}
        service_account: ${{ secrets.GCP_DEPLOY_SA }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ secrets.GCP_LOCATION }}-docker.pkg.dev

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Create virtual environment
      run: uv venv

    - name: Test dependencies (latest version)
      run: |
        uv pip install -e .[test]
        python --version
        uv pip list
        uv run pytest

    - name: Build and Push Docker image
      run: |
        docker build --build-arg GIT_SHA="${{ env.GIT_COMMIT_SHA }}" -t "${{ env.IMAGE_URI }}" .
        docker push "${{ env.IMAGE_URI }}"

    - name: Create env-vars.yaml
      run: |
        cat <<EOF > env-vars.yaml
        MLFLOW_TRACKING_URI: "${{ secrets.MLFLOW_TRACKING_URI }}"
        MLFLOW_TRACKING_USERNAME: "${{ secrets.MLFLOW_TRACKING_USERNAME }}"
        MLFLOW_TRACKING_PASSWORD: "${{ secrets.MLFLOW_TRACKING_PASSWORD }}"
        MLFLOW_EXPERIMENT_NAME: "${{ env.MLFLOW_EXPERIMENT_NAME }}"
        MLFLOW_MODEL_NAME: "${{ env.MLFLOW_MODEL_NAME }}"
        GCP_PROJECT_ID: "${{ secrets.GCP_PROJECT_ID }}"
        GCP_LOCATION: "${{ secrets.GCP_LOCATION }}"
        GCP_BQ_DATASET: "${{ secrets.GCP_BQ_DATASET }}"
        GIT_COMMIT_USERNAME: "${{ env.GIT_COMMIT_USERNAME }}"
        GIT_COMMIT_AUTHOR_NAME: "${{ env.GIT_COMMIT_AUTHOR_NAME }}"
        GIT_COMMIT_BRANCH: "${{ env.GIT_BRANCH }}"
        EOF

    - name: Deploy Cloud Run Job
      run: |
        gcloud run jobs deploy banking-pipeline-dev \
          --image "${{ env.IMAGE_URI }}" \
          --region ${{ secrets.GCP_LOCATION }} \
          --service-account ${{ secrets.GCP_MLFLOW_SA_NAME }} \
          --env-vars-file env-vars.yaml \
          --cpu 1 \
          --memory 800Mi \
          --execute-now
