name: Build and Deploy to Cloud Run Job

on:
  push:
    branches:
      - main

jobs:
  deploy:
    if: "${{ github.actor }} != 'github-actions[bot]'"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        persist-credentials: true

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_DEPLOY_SA }}

    - name: Detect polymodel code changes
      id: model_changes
      run: |
        # Compare the range provided by the push event (before -> sha)
        git fetch --no-tags --prune
        echo "Comparing ${{ github.event.before }}..${{ github.sha }}"
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^polymodel/|^polymodel/src/polymodel/'; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Bump polymodel version (patch)
      if: steps.model_changes.outputs.changed == 'true'
      run: |
        python - <<'PY'
        from pathlib import Path
        import re, sys

        TOML_PATH = Path('polymodel/pyproject.toml')

        content = TOML_PATH.read_text(encoding='utf-8')
        m = re.search(r'(?m)^version\s*=\s*"(?P<ver>\d+\.\d+\.\d+)"', content)
        if not m:
            print('version not found in', TOML_PATH)
            sys.exit(1)

        major, minor, patch = map(int, m.group('ver').split('.'))
        patch += 1
        new_version = f"{major}.{minor}.{patch}"

        updated = re.sub(r'version\s*=\s*"[^"]+"', f'version = "{new_version}"', content, count=1)
        TOML_PATH.write_text(updated, encoding='utf-8')
        print('bumped', TOML_PATH, 'to', new_version)
        PY

    - name: Commit & push version bump
      if: steps.model_changes.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add polymodel/pyproject.toml
        git commit -m "chore(polymodel): bump version [skip ci]"
        git push

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ secrets.GCP_LOCATION }}-docker.pkg.dev

    - name: Build and Push Docker image
      run: |
        IMAGE_URI="${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/pipeline:latest"
        docker build --build-arg GIT_SHA="${{ github.sha }}" -t "$IMAGE_URI" .
        docker push "$IMAGE_URI"

    - name: Create env-vars.yaml
      run: |
        cat <<EOF > env-vars.yaml
        MLFLOW_TRACKING_USERNAME: "${{ secrets.MLFLOW_TRACKING_USERNAME }}" 
        MLFLOW_TRACKING_PASSWORD: "${{ secrets.MLFLOW_TRACKING_PASSWORD }}"
        MLFLOW_EXPERIMENT_NAME: "CICD-Experiment"
        EOF

    - name: Deploy Cloud Run Job
      run: |
        gcloud run jobs deploy mlflow-pipeline \
          --image "${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/pipeline:latest" \
          --region ${{ secrets.GCP_LOCATION }} \
          --service-account ${{ secrets.GCP_MLFLOW_SA_NAME }} \
          --env-vars-file env-vars.yaml \
          --cpu 1 \
          --memory 500Mi \
          --execute-now
