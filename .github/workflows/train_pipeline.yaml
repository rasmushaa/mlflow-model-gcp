name: Build and Deploy to Cloud Run Job

on:
  push:
    branches:
      - main
      - dev

jobs:
  build_wheel:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write' # This is crucial for Workload Identity Federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id : ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL }}
        service_account: ${{ secrets.GCP_DEPLOY_SA }}

    - name: Resolve current polymodel version
      id: polymodel_version
      run: |
        VERSION=$(python - <<'EOF'
        from importlib.metadata import version
        print(version("polymodel")) EOF)
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Resolved current polymodel version: $VERSION"

    - name: Check if current polymodel version exists in Artifact Registry
      id: polymodel_exists
      run: |
        if gcloud artifacts versions list \
          --package=polymodel \
          --repository=python-packages \
          --location=${{ secrets.GCP_LOCATION }} \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --format="value(name)" | grep -q "${{ steps.polymodel_version.outputs.version }}"; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
          echo "Version already exists on GCP Artifact Registry. Skipping build and upload."
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
          echo "Version does not exist on GCP Artifact Registry. Proceeding with build and upload."
        fi

    - name: Build and Upload polymodel package wheel
      if: steps.polymodel_exists.outputs.exists == 'false'
      uses: astral-sh/setup-uv@v7
      with:
          version: "0.9.9"
      run: |
        echo "Installing uv..."
        uv venv
        uv sync --dev # Install dev dependencies from repo pyproject.toml

        echo "Building polymodel ${{ steps.polymodel_version.outputs.version }} with uv..."
        uv build polymodel/ --out-dir ./polymodel_dist/

        echo "Uploading polymodel ${{ steps.polymodel_version.outputs.version }} to GCP Artifact Registry..."
        uv run twine upload \
          --repository-url https://${{ secrets.GCP_LOCATION }}-python.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/python-packages/ \
          ./polymodel_dist/* --verbose

    - name: Skip upload (version already exists)
      if: steps.polymodel_exists.outputs.exists == 'true'
      run: |
        echo "Skipping upload: polymodel version ${{ steps.polymodel_version.outputs.version }} already exists in Artifact Registry."


  deploy_job:
    runs-on: ubuntu-latest
    needs: build_wheel

    permissions:
      contents: 'read'
      id-token: 'write' # This is crucial for Workload Identity Federation

    steps:
    - name: Init Environment Variables
      run: |
        if [ "${{ github.ref_name }}" == "main" ]; then
          echo "IMAGE_URI=${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/pipeline-main:latest" >> $GITHUB_ENV
          echo "MLFLOW_EXPERIMENT_NAME=Experiment-main" >> $GITHUB_ENV
          echo "MLFLOW_MODEL_NAME=BankingModel-main" >> $GITHUB_ENV
        else
          echo "IMAGE_URI=${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/pipeline-dev:latest" >> $GITHUB_ENV
          echo "MLFLOW_EXPERIMENT_NAME=Experiment-dev" >> $GITHUB_ENV
          echo "MLFLOW_MODEL_NAME=BankingModel-dev" >> $GITHUB_ENV
        fi
        echo "GIT_COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_USERNAME=${{ github.actor }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_AUTHOR_NAME=${{ github.event.head_commit.author.name }}" >> $GITHUB_ENV

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id : ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL }}
        service_account: ${{ secrets.GCP_DEPLOY_SA }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ secrets.GCP_LOCATION }}-docker.pkg.dev

    - name: Build and Push Docker image
      run: |
        docker build --build-arg GIT_SHA="${{ env.GIT_COMMIT_SHA }}" -t "${{ env.IMAGE_URI }}" .
        docker push "${{ env.IMAGE_URI }}"

    - name: Create env-vars.yaml
      run: |
        cat <<EOF > env-vars.yaml
        MLFLOW_TRACKING_URI: "${{ secrets.MLFLOW_TRACKING_URI }}"
        MLFLOW_TRACKING_USERNAME: "${{ secrets.MLFLOW_TRACKING_USERNAME }}"
        MLFLOW_TRACKING_PASSWORD: "${{ secrets.MLFLOW_TRACKING_PASSWORD }}"
        MLFLOW_EXPERIMENT_NAME: "${{ env.MLFLOW_EXPERIMENT_NAME }}"
        MLFLOW_MODEL_NAME: "${{ env.MLFLOW_MODEL_NAME }}"
        GCP_PROJECT_ID: "${{ secrets.GCP_PROJECT_ID }}"
        GCP_LOCATION: "${{ secrets.GCP_LOCATION }}"
        GCP_BQ_DATASET: "${{ secrets.GCP_BQ_DATASET }}"
        GIT_COMMIT_USERNAME: "${{ env.GIT_COMMIT_USERNAME }}"
        GIT_COMMIT_AUTHOR_NAME: "${{ env.GIT_COMMIT_AUTHOR_NAME }}"
        EOF

    - name: Deploy Cloud Run Job
      run: |
        gcloud run jobs deploy mlflow-pipeline \
          --image "${{ env.IMAGE_URI }}" \
          --region ${{ secrets.GCP_LOCATION }} \
          --service-account ${{ secrets.GCP_MLFLOW_SA_NAME }} \
          --env-vars-file env-vars.yaml \
          --cpu 1 \
          --memory 800Mi \
          --execute-now
