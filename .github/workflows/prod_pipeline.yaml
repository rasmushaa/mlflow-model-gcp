# =============================================================================
# Build Wheel and Production Training Pipeline - Main Branch
# =============================================================================
#
# PURPOSE:
# Combined workflow that:
# 1. Always builds and uploads the polymodel Python wheel package on any PR merge to main
# 2. Conditionally deploys and executes production ML training pipeline only when
#    merging from branches starting with "model/"
#
# TRIGGER:
# Runs when a PR is successfully merged to the main branch (not on closed without merging).
# This ensures only reviewed and approved code versions are published and deployed.
#
# LOGIC FLOW:
# WHEEL BUILD (always runs):
# 1. Extract version from polymodel/pyproject.toml
# 2. Check if this version already exists in GCP Artifact Registry
# 3. If version exists: Skip build and upload (prevents duplicate uploads)
# 4. If version is new: Build wheel with uv and upload via twine
#
# PRODUCTION PIPELINE (only for model/* branches):
# 1. Check if merged branch name starts with "model/"
# 2. Build production Docker image tagged with commit SHA
# 3. Deploy to Cloud Run Job with production configuration
# 4. Execute training job immediately with production MLflow experiment
#
# NAMING CONVENTION:
# - Wheel: polymodel-{version}.whl
# - Image: banking-pipeline-main:latest
# - Experiment: Banking
# - Model: BankingModel
#
# WHY COMBINED:
# - Wheel must be built before production training runs (which depends on it)
# - Single workflow avoids complexity of passing data between workflows
# - Direct access to PR metadata (github.event.pull_request.head.ref) for branch filtering
# - Ensures production quality gates are met before deployment
# - Clear separation between dev and prod environments
#
# META:
# Build Docker image with embedded git commit SHA for traceability.
# The GIT_SHA build arg ensures the exact code version is baked into the image,
# allowing us to trace back which commit produced a particular model or result.
# Create environment variables file for Cloud Run Job.
# Git-related variables (GIT_COMMIT_USERNAME, GIT_COMMIT_AUTHOR_NAME, GIT_COMMIT_BRANCH)
# are passed to the training script and logged as MLflow metadata/tags.
# This enables tracking which developer, branch, and commit produced each model.
# =============================================================================

name: Build Wheel and Production Training Pipeline

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  build_wheel_and_deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    # =========================================================================
    # WHEEL BUILD STEPS (Always run on merge to main)
    # =========================================================================
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id : ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL }}
        service_account: ${{ secrets.GCP_DEPLOY_SA }}

    - name: Resolve current polymodel version
      id: polymodel_version
      run: |
        VERSION=$(python - <<'EOF'
        import tomllib

        with open("polymodel/pyproject.toml", "rb") as f:
            data = tomllib.load(f)

        print(data["project"]["version"])
        EOF
        )
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Resolved current polymodel version: $VERSION"

    - name: Check if current polymodel version exists in Artifact Registry
      id: polymodel_exists
      run: |
        if gcloud artifacts versions list \
          --package=polymodel \
          --repository=python-packages \
          --location=${{ secrets.GCP_LOCATION }} \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --format="value(name)" | grep -q "${{ steps.polymodel_version.outputs.version }}"; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
          echo "Version already exists on GCP Artifact Registry. Skipping build and upload."
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
          echo "Version does not exist on GCP Artifact Registry. Proceeding with build and upload."
        fi

    - name: Setup uv
      if: steps.polymodel_exists.outputs.exists == 'false'
      uses: astral-sh/setup-uv@v7
      with:
          version: "0.9.9"

    - name: Build and Upload polymodel package wheel
      if: steps.polymodel_exists.outputs.exists == 'false'
      run: |
        echo "Installing uv env..."
        uv venv
        uv sync --dev # Install dev dependencies from repo pyproject.toml

        echo "Building polymodel ${{ steps.polymodel_version.outputs.version }} with uv..."
        uv build polymodel/ --out-dir ./polymodel_dist/

        echo "Uploading polymodel ${{ steps.polymodel_version.outputs.version }} to GCP Artifact Registry..."
        uv run twine upload \
          --repository-url https://${{ secrets.GCP_LOCATION }}-python.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/python-packages/ \
          ./polymodel_dist/* --verbose

    - name: Skip upload (version already exists)
      if: steps.polymodel_exists.outputs.exists == 'true'
      run: |
        echo "Skipping upload: polymodel version ${{ steps.polymodel_version.outputs.version }} already exists in Artifact Registry."

    # =========================================================================
    # PRODUCTION PIPELINE STEPS (Only for model/* branches)
    # =========================================================================
    - name: Init Environment Variables
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        echo "IMAGE_URI=${{ secrets.GCP_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mlflow-images/banking-pipeline-main:latest" >> $GITHUB_ENV
        echo "MLFLOW_EXPERIMENT_NAME=Banking" >> $GITHUB_ENV
        echo "MLFLOW_MODEL_NAME=BankingModel" >> $GITHUB_ENV
        echo "GIT_BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "GIT_COMMIT_USERNAME=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

    - name: Set up Google Cloud SDK
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker to use gcloud as a credential helper
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        gcloud auth configure-docker ${{ secrets.GCP_LOCATION }}-docker.pkg.dev

    - name: Build and Push Docker image
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        docker build --build-arg GIT_SHA="${{ env.GIT_COMMIT_SHA }}" -t "${{ env.IMAGE_URI }}" .
        docker push "${{ env.IMAGE_URI }}"

    - name: Create env-vars.yaml
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        cat <<EOF > env-vars.yaml
        MLFLOW_TRACKING_URI: "${{ secrets.MLFLOW_TRACKING_URI }}"
        MLFLOW_TRACKING_USERNAME: "${{ secrets.MLFLOW_TRACKING_USERNAME }}"
        MLFLOW_TRACKING_PASSWORD: "${{ secrets.MLFLOW_TRACKING_PASSWORD }}"
        MLFLOW_EXPERIMENT_NAME: "${{ env.MLFLOW_EXPERIMENT_NAME }}"
        MLFLOW_MODEL_NAME: "${{ env.MLFLOW_MODEL_NAME }}"
        GCP_PROJECT_ID: "${{ secrets.GCP_PROJECT_ID }}"
        GCP_LOCATION: "${{ secrets.GCP_LOCATION }}"
        GCP_BQ_DATASET: "${{ secrets.GCP_BQ_DATASET }}"
        GIT_COMMIT_USERNAME: "${{ env.GIT_COMMIT_USERNAME }}"
        GIT_COMMIT_BRANCH: "${{ env.GIT_BRANCH }}"
        EOF

    - name: Deploy and Execute Cloud Run Job
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        gcloud run jobs deploy banking-pipeline-prod \
          --image "${{ env.IMAGE_URI }}" \
          --region ${{ secrets.GCP_LOCATION }} \
          --service-account ${{ secrets.GCP_MLFLOW_SA_NAME }} \
          --env-vars-file env-vars.yaml \
          --cpu 1 \
          --memory 800Mi \
          --execute-now \
          --max-retries 0

    - name: Summary
      if: startsWith(github.event.pull_request.head.ref, 'model/')
      run: |
        echo "================================================"
        echo "âœ… Production Training Pipeline Deployed"
        echo "Branch: ${{ env.GIT_BRANCH }}"
        echo "Commit: ${{ env.GIT_COMMIT_SHA }}"
        echo "Experiment: ${{ env.MLFLOW_EXPERIMENT_NAME }}"
        echo "Model: ${{ env.MLFLOW_MODEL_NAME }}"
        echo "================================================"
